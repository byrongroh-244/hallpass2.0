<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --color-ink: #0f172a;
            --color-slate: #475569;
            --color-cloud: #f1f5f9;
            --color-paper: #ffffff;
            --color-primary: #667eea;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%);
            padding: 2rem;
            color: var(--color-ink);
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .header h1 { 
            font-family: 'Fraunces', serif; 
            font-size: 2rem; 
            margin-bottom: 0.5rem;
        }
        .header p {
            color: var(--color-slate);
            font-size: 0.9375rem;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-slate);
        }
        .tab:hover { background: var(--color-cloud); }
        .tab.active {
            background: var(--color-primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .card h2 {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Overview Filters */
        .overview-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .filter-button-group {
            display: flex;
            gap: 0.5rem;
            background: var(--color-cloud);
            padding: 0.25rem;
            border-radius: 8px;
        }
        .filter-button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-slate);
            font-size: 0.875rem;
        }
        .filter-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .filter-button.active {
            background: white;
            color: var(--color-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-label {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-slate);
            margin-right: 0.5rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stat-label {
            font-size: 0.875rem;
            color: var(--color-slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-ink);
        }
        
        /* Two column layout for Overview */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 1024px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-slate);
        }
        .filters select, .filters input {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            min-width: 150px;
        }
        .filters button {
            padding: 0.75rem 1.5rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            align-self: flex-end;
        }
        .filters button:hover {
            background: #5568d3;
        }
        
        /* Top 10 List */
        .top-list {
            list-style: none;
        }
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .top-item:hover {
            background: var(--color-cloud);
        }
        .top-item:last-child {
            border-bottom: none;
        }
        .rank {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-right: 1rem;
            min-width: 40px;
        }
        .student-info {
            flex: 1;
        }
        .student-name {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--color-primary);
        }
        .student-name:hover {
            text-decoration: underline;
        }
        .student-details {
            font-size: 0.875rem;
            color: var(--color-slate);
            margin-top: 0.25rem;
        }
        .time-badge {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.125rem;
            padding: 0.5rem 1rem;
            background: var(--color-cloud);
            border-radius: 8px;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 0.75rem;
            background: #f8fafc;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.875rem;
        }
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        tr:hover {
            background: #f8fafc;
        }
        .clickable-student {
            cursor: pointer;
            color: var(--color-primary);
            font-weight: 600;
        }
        .clickable-student:hover {
            text-decoration: underline;
        }
        
        /* Student Detail View */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .detail-card {
            background: var(--color-cloud);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--color-primary);
        }
        .detail-label {
            font-size: 0.875rem;
            color: var(--color-slate);
            margin-bottom: 0.5rem;
        }
        .detail-value {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            font-weight: 700;
        }
        
        /* Export Button */
        .export-btn {
            padding: 0.75rem 1.5rem;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .export-btn:hover {
            background: #059669;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--color-slate);
        }
        
        /* Badge for trip types */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.warning { background: #fef3c7; color: #92400e; }
        .badge.danger { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Analytics Dashboard</h1>
        <p>Comprehensive hall pass analytics and insights</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">üè† Overview</button>
        <button class="tab" onclick="switchTab('class')">üìö By Class</button>
        <button class="tab" onclick="switchTab('student')">üë§ By Student</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
        <div class="overview-filters">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="filter-label">Schedule:</span>
                <div class="filter-button-group">
                    <button class="filter-button active" data-filter="schedule" data-value="all" onclick="updateOverviewFilter('schedule', 'all')">All</button>
                    <button class="filter-button" data-filter="schedule" data-value="red" onclick="updateOverviewFilter('schedule', 'red')">üî¥ Red</button>
                    <button class="filter-button" data-filter="schedule" data-value="black" onclick="updateOverviewFilter('schedule', 'black')">‚ö´ Black</button>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="filter-label">Period:</span>
                <div class="filter-button-group">
                    <button class="filter-button active" data-filter="period" data-value="all" onclick="updateOverviewFilter('period', 'all')">All</button>
                    <button class="filter-button" data-filter="period" data-value="P1" onclick="updateOverviewFilter('period', 'P1')">P1</button>
                    <button class="filter-button" data-filter="period" data-value="P2" onclick="updateOverviewFilter('period', 'P2')">P2</button>
                    <button class="filter-button" data-filter="period" data-value="P3" onclick="updateOverviewFilter('period', 'P3')">P3</button>
                    <button class="filter-button" data-filter="period" data-value="P4" onclick="updateOverviewFilter('period', 'P4')">P4</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Trips (14 Days)</div>
                <div class="stat-value" id="overviewTotalTrips">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Time Out</div>
                <div class="stat-value" id="overviewTotalTime">0h</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Trip Duration</div>
                <div class="stat-value" id="overviewAvgDuration">0m</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Forgot to Scan Back</div>
                <div class="stat-value" id="overviewForgotRate">0%</div>
            </div>
        </div>

        <div class="two-column">
            <div class="card">
                <h2>üìà Trips by Period</h2>
                <div class="chart-container">
                    <canvas id="periodChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üèÜ Top 10 High Flyers</h2>
                <p style="color: var(--color-slate); margin-bottom: 1rem; font-size: 0.875rem;">Click to view student details</p>
                <ul class="top-list" id="topFlyersList"></ul>
            </div>
        </div>
    </div>

    <!-- CLASS TAB -->
    <div id="class" class="tab-content">
        <div class="card">
            <h2>üîç Filter by Class</h2>
            <div class="filters">
                <div class="filter-group">
                    <label>Period</label>
                    <select id="classPeriodFilter">
                        <option value="all">All Periods</option>
                        <option value="P1">Period 1</option>
                        <option value="P2">Period 2</option>
                        <option value="P3">Period 3</option>
                        <option value="P4">Period 4</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Schedule Day</label>
                    <select id="classScheduleFilter">
                        <option value="all">All Days</option>
                        <option value="red">Red Day</option>
                        <option value="black">Black Day</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Start Type</label>
                    <select id="classStartFilter">
                        <option value="all">All Types</option>
                        <option value="regular">Regular Start</option>
                        <option value="late">Late Start</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Time Range</label>
                    <select id="classTimeRange">
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <button onclick="applyClassFilters()">Apply Filters</button>
            </div>
            <div id="customDateRange" style="display: none; margin-bottom: 1rem;">
                <div class="filters">
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" id="classStartDate">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" id="classEndDate">
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="classStatsGrid">
            <div class="stat-card">
                <div class="stat-label">Total Students</div>
                <div class="stat-value" id="classStudentCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Student Trips</div>
                <div class="stat-value" id="classTotalTrips">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Trip Length</div>
                <div class="stat-value" id="classAvgTripLength">0m</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Students Over 10 Min</div>
                <div class="stat-value" id="classOver10Min">0</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Class Details</h2>
            <p style="color: var(--color-slate); margin-bottom: 1rem; font-size: 0.875rem;">Click student name to view their details</p>
            <div id="classTableContainer"></div>
        </div>
    </div>

    <!-- STUDENT TAB -->
    <div id="student" class="tab-content">
        <div class="card">
            <h2>üë§ Select Student</h2>
            <div class="filters">
                <div class="filter-group">
                    <label>Schedule Day</label>
                    <select id="studentScheduleFilter" onchange="updateStudentPeriodFilter()">
                        <option value="">-- Select schedule --</option>
                        <option value="red">Red Day</option>
                        <option value="black">Black Day</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Period</label>
                    <select id="studentPeriodFilter" onchange="updateStudentNameFilter()" disabled>
                        <option value="">-- Select period --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Student Name</label>
                    <select id="studentSelect" onchange="loadStudentData()" disabled>
                        <option value="">-- Select student --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>View Period</label>
                    <select id="studentTimeRange" onchange="loadStudentData()">
                        <option value="day">Today</option>
                        <option value="week">This Week</option>
                        <option value="twoweeks" selected>Last 2 Weeks</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <button class="export-btn" onclick="exportStudentReport()">Export Report</button>
            </div>
        </div>

        <div id="studentDetailsContainer" style="display: none;">
            <div class="card">
                <h2 id="studentDetailName">Student Details</h2>
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Total Trips</div>
                        <div class="detail-value" id="studentTotalTrips">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Total Time Out</div>
                        <div class="detail-value" id="studentTotalTime">0h</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Avg Trip Duration</div>
                        <div class="detail-value" id="studentAvgDuration">0m</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Longest Trip</div>
                        <div class="detail-value" id="studentLongestTrip">0m</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Trips Per Day</div>
                        <div class="detail-value" id="studentTripsPerDay">0</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Forgot to Scan Back</div>
                        <div class="detail-value" id="studentForgotRate">0%</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ Day of Week Pattern</h2>
                <div class="chart-container">
                    <canvas id="studentDayChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üìã Recent Trips</h2>
                <div id="studentTripsTable"></div>
            </div>
        </div>

        <div id="noStudentSelected" class="card">
            <div class="loading">Select schedule, period, and student to view detailed analytics</div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - EDIT THIS SECTION ONLY
        // ============================================
        const CONFIG = {
            firebase: {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_PROJECT.firebaseapp.com",
                databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            },
            schedules: {
                red: {
                    regular: [
                        { name: "P1", students: { "qr_01": "Student A1", "qr_02": "Student A2" } },
                        { name: "P2", students: { "qr_11": "Student B1" } }
                    ],
                    late: [
                        { name: "P1", students: { "qr_01": "Student A1" } }
                    ]
                },
                black: {
                    regular: [
                        { name: "P1", students: { "qr_11": "Student E1" } }
                    ],
                    late: [
                        { name: "P1", students: { "qr_11": "Student E1" } }
                    ]
                }
            }
        };

        // ============================================
        // SYSTEM CODE - DO NOT EDIT BELOW
        // ============================================
        
        firebase.initializeApp(CONFIG.firebase);
        const database = firebase.database();
        let allLogs = [];
        let charts = {};
        let overviewFilters = { schedule: 'all', period: 'all' };

        function formatDurationHours(ms) {
            if (!ms || ms < 0) return '0m';
            const totalMinutes = Math.floor(ms / 60000);
            if (totalMinutes < 60) return `${totalMinutes}m`;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
        }

        function formatDuration(ms) {
            if (!ms || ms < 0) return '0:00';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        function getDateRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days);
            return {
                startDate: start.toISOString().split('T')[0],
                endDate: end.toISOString().split('T')[0]
            };
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'overview' && allLogs.length > 0) {
                loadOverviewData();
            } else if (tabName === 'class' && allLogs.length > 0) {
                applyClassFilters();
            }
        };

        async function loadAllData() {
            try {
                const range = getDateRange(14);
                const snap = await database.ref('logs')
                    .orderByChild('date')
                    .startAt(range.startDate)
                    .endAt(range.endDate)
                    .once('value');
                
                allLogs = [];
                snap.forEach(child => {
                    allLogs.push({ id: child.key, ...child.val() });
                });
                
                loadOverviewData();
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }

        // OVERVIEW TAB with filters
        window.updateOverviewFilter = function(filterType, value) {
            overviewFilters[filterType] = value;
            
            // Update button states
            document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === value) {
                    btn.classList.add('active');
                }
            });
            
            loadOverviewData();
        };

        function loadOverviewData() {
            let filtered = allLogs.filter(log => 
                log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset'
            );
            
            // Apply filters
            if (overviewFilters.schedule !== 'all') {
                filtered = filtered.filter(log => log.schedule?.includes(overviewFilters.schedule));
            }
            if (overviewFilters.period !== 'all') {
                filtered = filtered.filter(log => log.period === overviewFilters.period);
            }
            
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgDuration = totalTrips > 0 ? totalTime / totalTrips : 0;
            const forgotCount = filtered.filter(log => 
                log.action === 'auto-reset' || log.action === 'manual-reset'
            ).length;
            const forgotRate = totalTrips > 0 ? (forgotCount / totalTrips * 100).toFixed(1) : 0;
            
            document.getElementById('overviewTotalTrips').textContent = totalTrips;
            document.getElementById('overviewTotalTime').textContent = formatDurationHours(totalTime);
            document.getElementById('overviewAvgDuration').textContent = formatDurationHours(avgDuration);
            document.getElementById('overviewForgotRate').textContent = forgotRate + '%';
            
            // Period chart
            const periodData = {};
            filtered.forEach(log => {
                const period = log.period || 'Unknown';
                periodData[period] = (periodData[period] || 0) + 1;
            });
            
            const ctx = document.getElementById('periodChart');
            if (charts.period) charts.period.destroy();
            charts.period = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(periodData).sort(),
                    datasets: [{
                        label: 'Number of Trips',
                        data: Object.keys(periodData).sort().map(k => periodData[k]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
            
            // Top 10
            const studentData = {};
            filtered.forEach(log => {
                if (!studentData[log.studentName]) {
                    studentData[log.studentName] = { 
                        name: log.studentName, 
                        totalTime: 0, 
                        trips: 0 
                    };
                }
                studentData[log.studentName].totalTime += log.duration || 0;
                studentData[log.studentName].trips++;
            });
            
            const top10 = Object.values(studentData)
                .sort((a, b) => b.totalTime - a.totalTime)
                .slice(0, 10);
            
            const topList = document.getElementById('topFlyersList');
            topList.innerHTML = top10.map((student, index) => `
                <li class="top-item" onclick="jumpToStudent('${student.name}')">
                    <div class="rank">#${index + 1}</div>
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-details">${student.trips} trips ‚Ä¢ Avg ${formatDurationHours(student.totalTime / student.trips)}</div>
                    </div>
                    <div class="time-badge">${formatDurationHours(student.totalTime)}</div>
                </li>
            `).join('');
        }

        // CLASS TAB
        document.getElementById('classTimeRange').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customDateRange').style.display = 'block';
                const today = new Date();
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(today.getDate() - 14);
                document.getElementById('classStartDate').valueAsDate = twoWeeksAgo;
                document.getElementById('classEndDate').valueAsDate = today;
            } else {
                document.getElementById('customDateRange').style.display = 'none';
            }
        });

        window.applyClassFilters = function() {
            const period = document.getElementById('classPeriodFilter').value;
            const schedule = document.getElementById('classScheduleFilter').value;
            const startType = document.getElementById('classStartFilter').value;
            const timeRange = document.getElementById('classTimeRange').value;
            
            let startDate, endDate;
            if (timeRange === 'custom') {
                startDate = document.getElementById('classStartDate').value;
                endDate = document.getElementById('classEndDate').value;
            } else {
                const days = timeRange === 'week' ? 7 : 30;
                const range = getDateRange(days);
                startDate = range.startDate;
                endDate = range.endDate;
            }
            
            const filtered = allLogs.filter(log => {
                if (log.date < startDate || log.date > endDate) return false;
                if (period !== 'all' && log.period !== period) return false;
                if (schedule !== 'all' && !log.schedule?.includes(schedule)) return false;
                if (startType !== 'all' && !log.schedule?.includes(startType)) return false;
                return log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset';
            });
            
            const students = new Set(filtered.map(log => log.studentName));
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgTripLength = totalTrips > 0 ? totalTime / totalTrips : 0;
            
            const studentMaxTrips = {};
            filtered.forEach(log => {
                const name = log.studentName;
                if (!studentMaxTrips[name] || log.duration > studentMaxTrips[name]) {
                    studentMaxTrips[name] = log.duration || 0;
                }
            });
            const over10Min = Object.values(studentMaxTrips).filter(duration => duration > 600000).length;
            
            document.getElementById('classStudentCount').textContent = students.size;
            document.getElementById('classTotalTrips').textContent = totalTrips;
            document.getElementById('classAvgTripLength').textContent = formatDurationHours(avgTripLength);
            document.getElementById('classOver10Min').textContent = over10Min;
            
            const studentData = {};
            filtered.forEach(log => {
                if (!studentData[log.studentName]) {
                    studentData[log.studentName] = {
                        name: log.studentName,
                        trips: 0,
                        totalTime: 0
                    };
                }
                studentData[log.studentName].trips++;
                studentData[log.studentName].totalTime += log.duration || 0;
            });
            
            const sorted = Object.values(studentData).sort((a, b) => b.totalTime - a.totalTime);
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Total Trips</th>
                            <th>Total Time Out</th>
                            <th>Avg Per Trip</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach(s => {
                html += `
                    <tr>
                        <td><span class="clickable-student" onclick="jumpToStudent('${s.name}')">${s.name}</span></td>
                        <td>${s.trips}</td>
                        <td>${formatDurationHours(s.totalTime)}</td>
                        <td>${formatDurationHours(s.totalTime / s.trips)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('classTableContainer').innerHTML = html;
        };

        window.jumpToStudent = function(studentName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[2].classList.add('active');
            document.getElementById('student').classList.add('active');
            
            const studentLog = allLogs.find(log => log.studentName === studentName);
            if (studentLog && studentLog.schedule) {
                const scheduleParts = studentLog.schedule.split('_');
                const scheduleDay = scheduleParts[0];
                
                document.getElementById('studentScheduleFilter').value = scheduleDay;
                updateStudentPeriodFilter();
                
                setTimeout(() => {
                    document.getElementById('studentPeriodFilter').value = studentLog.period;
                    updateStudentNameFilter();
                    
                    setTimeout(() => {
                        document.getElementById('studentSelect').value = studentName;
                        loadStudentData();
                    }, 100);
                }, 100);
            }
        };

        // STUDENT TAB
        window.updateStudentPeriodFilter = function() {
            const scheduleDay = document.getElementById('studentScheduleFilter').value;
            const periodSelect = document.getElementById('studentPeriodFilter');
            const studentSelect = document.getElementById('studentSelect');
            
            periodSelect.innerHTML = '<option value="">-- Select period --</option>';
            studentSelect.innerHTML = '<option value="">-- Select student --</option>';
            studentSelect.disabled = true;
            
            if (!scheduleDay) {
                periodSelect.disabled = true;
                return;
            }
            
            periodSelect.disabled = false;
            
            const periods = new Set();
            allLogs.forEach(log => {
                if (log.schedule && log.schedule.includes(scheduleDay) && log.period) {
                    periods.add(log.period);
                }
            });
            
            Array.from(periods).sort().forEach(period => {
                periodSelect.innerHTML += `<option value="${period}">${period}</option>`;
            });
        };

        window.updateStudentNameFilter = function() {
            const scheduleDay = document.getElementById('studentScheduleFilter').value;
            const period = document.getElementById('studentPeriodFilter').value;
            const studentSelect = document.getElementById('studentSelect');
            
            studentSelect.innerHTML = '<option value="">-- Select student --</option>';
            
            if (!scheduleDay || !period) {
                studentSelect.disabled = true;
                return;
            }
            
            studentSelect.disabled = false;
            
            const students = new Set();
            allLogs.forEach(log => {
                if (log.schedule && log.schedule.includes(scheduleDay) && 
                    log.period === period && log.studentName) {
                    students.add(log.studentName);
                }
            });
            
            Array.from(students).sort().forEach(name => {
                studentSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        };

        window.loadStudentData = function() {
            const studentName = document.getElementById('studentSelect').value;
            if (!studentName) {
                document.getElementById('studentDetailsContainer').style.display = 'none';
                document.getElementById('noStudentSelected').style.display = 'block';
                return;
            }
            
            document.getElementById('studentDetailsContainer').style.display = 'block';
            document.getElementById('noStudentSelected').style.display = 'none';
            
            const timeRange = document.getElementById('studentTimeRange').value;
            let days;
            if (timeRange === 'day') days = 1;
            else if (timeRange === 'week') days = 7;
            else if (timeRange === 'twoweeks') days = 14;
            else days = 30;
            
            const range = getDateRange(days);
            const filtered = allLogs.filter(log => 
                log.studentName === studentName &&
                log.date >= range.startDate &&
                log.date <= range.endDate &&
                (log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset')
            );
            
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgDuration = totalTrips > 0 ? totalTime / totalTrips : 0;
            const longestTrip = Math.max(...filtered.map(log => log.duration || 0), 0);
            const uniqueDays = new Set(filtered.map(log => log.date)).size;
            const tripsPerDay = uniqueDays > 0 ? (totalTrips / uniqueDays).toFixed(1) : 0;
            const forgotCount = filtered.filter(log => 
                log.action === 'auto-reset' || log.action === 'manual-reset'
            ).length;
            const forgotRate = totalTrips > 0 ? (forgotCount / totalTrips * 100).toFixed(1) : 0;
            
            document.getElementById('studentDetailName').textContent = `${studentName}'s Analytics`;
            document.getElementById('studentTotalTrips').textContent = totalTrips;
            document.getElementById('studentTotalTime').textContent = formatDurationHours(totalTime);
            document.getElementById('studentAvgDuration').textContent = formatDurationHours(avgDuration);
            document.getElementById('studentLongestTrip').textContent = formatDurationHours(longestTrip);
            document.getElementById('studentTripsPerDay').textContent = tripsPerDay;
            document.getElementById('studentForgotRate').textContent = forgotRate + '%';
            
            const dayData = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
            filtered.forEach(log => {
                const date = new Date(log.date);
                const day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                if (dayData[day] !== undefined) dayData[day]++;
            });
            
            const ctx = document.getElementById('studentDayChart');
            if (charts.studentDay) charts.studentDay.destroy();
            charts.studentDay = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayData),
                    datasets: [{
                        label: 'Trips',
                        data: Object.values(dayData),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
            
            const recent = filtered.slice().reverse().slice(0, 20);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Period</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(log => {
                const date = new Date(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                let badge = '';
                if (log.action === 'in') badge = '<span class="badge success">Normal</span>';
                else if (log.action === 'auto-reset') badge = '<span class="badge warning">Auto Reset</span>';
                else badge = '<span class="badge danger">Manual Reset</span>';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${log.period}</td>
                        <td>${formatDurationHours(log.duration)}</td>
                        <td>${badge}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('studentTripsTable').innerHTML = html;
        };

        window.exportStudentReport = function() {
            const studentName = document.getElementById('studentSelect').value;
            if (!studentName) {
                alert('Please select a student first');
                return;
            }
            
            const filtered = allLogs.filter(log => log.studentName === studentName);
            let csv = 'Date,Period,Schedule,Action,Duration (minutes)\n';
            filtered.forEach(log => {
                const duration = log.duration ? (log.duration / 60000).toFixed(2) : '0';
                csv += `${log.date},${log.period},${log.schedule},${log.action},${duration}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${studentName.replace(/\s+/g, '-')}-report-${Date.now()}.csv`;
            a.click();
        };

        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
