<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --color-bg: #0a0e1a;
            --color-surface: #151922;
            --color-surface-elevated: #1e2433;
            --color-border: #2a3140;
            --color-text: #e4e7ec;
            --color-text-muted: #9ca3af;
            --color-primary: #3b82f6;
            --color-primary-dim: #1e40af;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-accent: #8b5cf6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 2rem;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-surface-elevated) 100%);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }
        
        .header-content h1 { 
            font-size: 2rem; 
            margin-bottom: 0.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-content p {
            color: var(--color-text-muted);
            font-size: 0.9375rem;
        }
        
        .settings-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-icon:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            transform: rotate(90deg);
        }
        
        .settings-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--color-text);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 2rem;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .modal-content h2 {
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: var(--color-danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        
        .btn-secondary:hover {
            background: var(--color-border);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--color-surface);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }
        
        .tab {
            flex: 1;
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text-muted);
            font-size: 0.9375rem;
        }
        
        .tab:hover { 
            background: var(--color-surface-elevated); 
            color: var(--color-text);
        }
        
        .tab.active {
            background: var(--color-primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Filters */
        .filters-container {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            background: var(--color-surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .filter-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            background: var(--color-bg);
            padding: 0.25rem;
            border-radius: 8px;
        }
        
        .filter-button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }
        
        .filter-button:hover {
            background: var(--color-surface);
            color: var(--color-text);
        }
        
        .filter-button.active {
            background: var(--color-primary);
            color: white;
        }
        
        select {
            padding: 0.625rem 1rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        select:hover {
            border-color: var(--color-primary);
        }
        
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input[type="date"] {
            padding: 0.625rem 1rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        input[type="date"]:hover {
            border-color: var(--color-primary);
        }
        
        input[type="date"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 12px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-primary);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-text);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            color: var(--color-text-muted);
        }
        
        .stat-change.positive {
            color: var(--color-success);
        }
        
        .stat-change.negative {
            color: var(--color-danger);
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .chart-card h3 {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: var(--color-text);
            font-weight: 700;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Top Students Table */
        .top-students {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .top-students h3 {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: var(--color-text);
            font-weight: 700;
        }
        
        .student-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .student-item:hover {
            background: var(--color-surface-elevated);
            border-color: var(--color-primary);
            transform: translateX(4px);
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .student-rank {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--color-surface-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }
        
        .student-item:nth-child(1) .student-rank {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .student-item:nth-child(2) .student-rank {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: white;
        }
        
        .student-item:nth-child(3) .student-rank {
            background: linear-gradient(135deg, #fb923c, #ea580c);
            color: white;
        }
        
        .student-name {
            font-weight: 600;
            color: var(--color-text);
        }
        
        .student-duration {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--color-danger);
            font-size: 0.9375rem;
        }
        
        /* Student Details Page */
        .student-header {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .student-select-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .student-details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .compact-chart {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .compact-chart h4 {
            font-size: 0.875rem;
            margin-bottom: 1rem;
            color: var(--color-text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .compact-chart-container {
            position: relative;
            height: 200px;
        }
        
        /* Compact Table */
        .compact-table {
            width: 100%;
        }
        
        .compact-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .compact-table th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            border-bottom: 1px solid var(--color-border);
        }
        
        .compact-table td {
            padding: 0.75rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .compact-table tr:hover {
            background: var(--color-bg);
        }
        
        .duration-green { color: var(--color-success); font-weight: 600; }
        .duration-yellow { color: var(--color-warning); font-weight: 600; }
        .duration-red { color: var(--color-danger); font-weight: 600; }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
        }
        
        .badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }
        
        .badge.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-muted);
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-muted);
        }
        
        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .student-details-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Analytics Dashboard</h1>
            <p>Comprehensive student tracking and analytics</p>
        </div>
        <button class="settings-icon" onclick="showSettingsModal()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            <p>Clear all stored data?</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideSettingsModal()">Cancel</button>
                <button class="btn-danger" onclick="clearAllData()">Clear Data</button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Overview</button>
        <button class="tab" onclick="switchTab('student')">By Student</button>
    </div>

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content active">
        <!-- Filters -->
        <div class="filters-container">
            <div class="filter-group">
                <div class="filter-label">Schedule</div>
                <div class="filter-buttons">
                    <button class="filter-button active" data-schedule="Red" onclick="setSchedule(this)">Red</button>
                    <button class="filter-button" data-schedule="Black" onclick="setSchedule(this)">Black</button>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Period</div>
                <select id="overviewPeriod" onchange="updateOverviewData()">
                    <option value="">All Periods</option>
                    <option value="1">Period 1</option>
                    <option value="2">Period 2</option>
                    <option value="3">Period 3</option>
                    <option value="4">Period 4</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Time Range</div>
                <div class="filter-buttons">
                    <button class="filter-button active" onclick="setTimeRange('overview', 'all')">All Time</button>
                    <button class="filter-button" onclick="setTimeRange('overview', 'week')">7 Days</button>
                    <button class="filter-button" onclick="setTimeRange('overview', '14days')">14 Days</button>
                    <button class="filter-button" onclick="setTimeRange('overview', 'month')">30 Days</button>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Custom Range</div>
                <input type="date" id="overviewStartDate" onchange="setTimeRange('overview', 'custom')">
                <input type="date" id="overviewEndDate" onchange="setTimeRange('overview', 'custom')">
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Students Tracked</div>
                <div class="stat-value" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Scans</div>
                <div class="stat-value" id="totalScans">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value" id="avgDuration">0m</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Trips Over 10 Min</div>
                <div class="stat-value" id="tripsOver10">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>14-Day Trend</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="top-students">
                <h3>Top 10 Students - Longest Trips</h3>
                <div id="topStudentsList" class="student-list">
                    <div class="loading">Loading data</div>
                </div>
            </div>
        </div>
    </div>

    <!-- By Student Tab -->
    <div id="studentTab" class="tab-content">
        <div class="student-header">
            <h2>Student Analysis</h2>
            <div class="student-select-container">
                <div class="filter-group">
                    <div class="filter-label">Schedule</div>
                    <div class="filter-buttons">
                        <button class="filter-button active" data-schedule="Red" onclick="setStudentSchedule(this)">Red</button>
                        <button class="filter-button" data-schedule="Black" onclick="setStudentSchedule(this)">Black</button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label">Period</div>
                    <select id="studentPeriod" onchange="updateStudentDropdown()">
                        <option value="1">Period 1</option>
                        <option value="2">Period 2</option>
                        <option value="3">Period 3</option>
                        <option value="4">Period 4</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label">Student</div>
                    <select id="studentSelect" onchange="loadStudentData()">
                        <option value="">-- Select student --</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="studentDetailsContainer" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total Trips</div>
                    <div class="stat-value" id="studentTotalTrips">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Time</div>
                    <div class="stat-value" id="studentTotalTime">0h</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Duration</div>
                    <div class="stat-value" id="studentAvgTime">0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Longest Trip</div>
                    <div class="stat-value" id="studentLongestTrip">0m</div>
                </div>
            </div>

            <!-- Compact 3-Column Layout -->
            <div class="student-details-grid">
                <div class="compact-chart">
                    <h4>Trips by Day</h4>
                    <div class="compact-chart-container">
                        <canvas id="studentTripsChart"></canvas>
                    </div>
                </div>
                
                <div class="compact-chart">
                    <h4>Time Out by Day</h4>
                    <div class="compact-chart-container">
                        <canvas id="studentTimeChart"></canvas>
                    </div>
                </div>
                
                <div class="compact-chart compact-table">
                    <h4>Recent Trips</h4>
                    <div id="studentTripsTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="2" class="no-data">No trips found</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="noStudentSelected" class="no-data">
            Please select a student to view their analytics
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhP77wKiXfbEIldQGF_yUh3DuDTN22vfY",
            authDomain: "scannerapp-25dab.firebaseapp.com",
            databaseURL: "https://scannerapp-25dab-default-rtdb.firebaseio.com",
            projectId: "scannerapp-25dab",
            storageBucket: "scannerapp-25dab.firebasestorage.app",
            messagingSenderId: "669842009798",
            appId: "1:669842009798:web:ba856e54e9bee7aa63f1be",
            measurementId: "G-GRK2XKDH7C"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let allLogs = [];
        let charts = {
            trend: null,
            studentTrips: null,
            studentTime: null
        };
        
        let currentFilters = {
            overview: { schedule: 'Red', period: '', timeRange: 'all', startDate: '', endDate: '' },
            student: { schedule: 'Red', period: '1' }
        };

        // Helper Functions
        function parseLocalDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatDurationHours(ms) {
            const minutes = Math.floor(ms / 60000);
            if (minutes < 60) return minutes + 'm';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours + 'h ' + mins + 'm';
        }

        function getTimeRangeDates(rangeType, startDateId, endDateId) {
            const now = new Date();
            let startDate, endDate = now.toISOString().split('T')[0];
            
            const range = currentFilters[rangeType === 'overview' ? 'overview' : 'student'].timeRange;
            
            if (range === 'custom') {
                startDate = document.getElementById(startDateId).value;
                endDate = document.getElementById(endDateId).value;
            } else if (range === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                startDate = weekAgo.toISOString().split('T')[0];
            } else if (range === '14days') {
                const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                startDate = twoWeeksAgo.toISOString().split('T')[0];
            } else if (range === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                startDate = monthAgo.toISOString().split('T')[0];
            } else {
                startDate = '2000-01-01';
            }
            
            return { startDate, endDate };
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'overview') {
                updateOverviewData();
            } else if (tabName === 'student') {
                updateStudentDropdown();
            }
        }

        // Filter Functions
        function setSchedule(button) {
            const schedule = button.dataset.schedule;
            currentFilters.overview.schedule = schedule;
            
            button.parentElement.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            updateOverviewData();
        }

        function setStudentSchedule(button) {
            const schedule = button.dataset.schedule;
            currentFilters.student.schedule = schedule;
            
            button.parentElement.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            updateStudentDropdown();
        }

        function setTimeRange(type, range) {
            if (type === 'overview') {
                currentFilters.overview.timeRange = range;
                
                document.querySelectorAll('.filters-container .filter-button').forEach(btn => {
                    if (btn.textContent.includes('Days') || btn.textContent.includes('Time')) {
                        btn.classList.remove('active');
                    }
                });
                
                if (range !== 'custom') {
                    event.target.classList.add('active');
                }
                
                updateOverviewData();
            }
        }

        // Settings Modal
        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                database.ref('logs').remove();
                allLogs = [];
                hideSettingsModal();
                updateOverviewData();
            }
        }

        // Load All Data
        function loadAllData() {
            database.ref('logs').on('value', snapshot => {
                allLogs = [];
                snapshot.forEach(child => {
                    allLogs.push(child.val());
                });
                console.log('Loaded logs:', allLogs.length);
                updateOverviewData();
            });
        }

        // Update Overview
        function updateOverviewData() {
            const { schedule, period, timeRange } = currentFilters.overview;
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            const range = getTimeRangeDates('overview', 'overviewStartDate', 'overviewEndDate');
            
            currentFilters.overview.period = document.getElementById('overviewPeriod').value;
            const periodFilter = currentFilters.overview.period;
            
            const filtered = allLogs.filter(log =>
                log.scheduleDay === scheduleDay &&
                (!periodFilter || log.period === periodFilter) &&
                log.date >= range.startDate &&
                log.date <= range.endDate &&
                (log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset' || log.action === 'manual-in')
            );
            
            // Calculate stats
            const uniqueStudents = new Set(filtered.map(log => log.studentName));
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgTime = totalTrips > 0 ? totalTime / totalTrips : 0;
            const tripsOver10 = filtered.filter(log => (log.duration || 0) > 600000).length;
            
            document.getElementById('totalStudents').textContent = uniqueStudents.size;
            document.getElementById('totalScans').textContent = totalTrips;
            document.getElementById('avgDuration').textContent = formatDurationHours(avgTime);
            document.getElementById('tripsOver10').textContent = tripsOver10;
            
            // 14-Day Trend Chart
            update14DayTrend(filtered);
            
            // Top 10 Students
            updateTopStudents(filtered);
        }

        function update14DayTrend(logs) {
            const last14Days = [];
            const now = new Date();
            for (let i = 13; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                last14Days.push(date.toISOString().split('T')[0]);
            }
            
            const tripsByDay = {};
            last14Days.forEach(date => tripsByDay[date] = 0);
            
            logs.forEach(log => {
                if (tripsByDay[log.date] !== undefined) {
                    tripsByDay[log.date]++;
                }
            });
            
            const ctx = document.getElementById('trendChart');
            if (charts.trend) charts.trend.destroy();
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last14Days.map(date => {
                        const d = parseLocalDate(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Trips',
                        data: Object.values(tripsByDay),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        function updateTopStudents(logs) {
            const studentTotals = {};
            
            logs.forEach(log => {
                if (!studentTotals[log.studentName]) {
                    studentTotals[log.studentName] = 0;
                }
                studentTotals[log.studentName] += log.duration || 0;
            });
            
            const sorted = Object.entries(studentTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let html = '';
            sorted.forEach(([name, duration], index) => {
                html += `
                    <div class="student-item" onclick="goToStudent('${name}')">
                        <div class="student-info">
                            <div class="student-rank">${index + 1}</div>
                            <div class="student-name">${name}</div>
                        </div>
                        <div class="student-duration">${formatDurationHours(duration)}</div>
                    </div>
                `;
            });
            
            if (sorted.length === 0) {
                html = '<div class="no-data">No data available</div>';
            }
            
            document.getElementById('topStudentsList').innerHTML = html;
        }

        function goToStudent(studentName) {
            // Switch to student tab
            switchTab('student');
            
            // Set the student in the dropdown
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.value = studentName;
            
            // Load their data
            loadStudentData();
        }

        // Student Tab Functions
        function updateStudentDropdown() {
            const { schedule, period } = currentFilters.student;
            currentFilters.student.period = document.getElementById('studentPeriod').value;
            
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            const periodValue = currentFilters.student.period;
            
            const students = new Set();
            allLogs.forEach(log => {
                if (log.scheduleDay === scheduleDay && log.period === periodValue && log.studentName) {
                    students.add(log.studentName);
                }
            });
            
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">-- Select student --</option>';
            Array.from(students).sort().forEach(name => {
                studentSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            document.getElementById('studentDetailsContainer').style.display = 'none';
            document.getElementById('noStudentSelected').style.display = 'block';
        }

        function loadStudentData() {
            const studentName = document.getElementById('studentSelect').value;
            if (!studentName) {
                document.getElementById('studentDetailsContainer').style.display = 'none';
                document.getElementById('noStudentSelected').style.display = 'block';
                return;
            }
            
            document.getElementById('studentDetailsContainer').style.display = 'block';
            document.getElementById('noStudentSelected').style.display = 'none';
            
            const { schedule, period } = currentFilters.student;
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            
            const filtered = allLogs.filter(log =>
                log.studentName === studentName &&
                log.scheduleDay === scheduleDay &&
                log.period === period &&
                (log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset' || log.action === 'manual-in')
            );
            
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgTime = totalTrips > 0 ? totalTime / totalTrips : 0;
            const longestTrip = Math.max(...filtered.map(log => log.duration || 0), 0);
            
            document.getElementById('studentTotalTrips').textContent = totalTrips;
            document.getElementById('studentTotalTime').textContent = formatDurationHours(totalTime);
            document.getElementById('studentAvgTime').textContent = formatDurationHours(avgTime);
            document.getElementById('studentLongestTrip').textContent = formatDurationHours(longestTrip);
            
            // Chart 1: Trips by day
            const dayTrips = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
            const dayTime = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
            
            filtered.forEach(log => {
                const date = parseLocalDate(log.date);
                const day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                if (dayTrips[day] !== undefined) {
                    dayTrips[day]++;
                    dayTime[day] += log.duration || 0;
                }
            });
            
            const ctx1 = document.getElementById('studentTripsChart');
            if (charts.studentTrips) charts.studentTrips.destroy();
            charts.studentTrips = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayTrips),
                    datasets: [{
                        label: 'Trips',
                        data: Object.values(dayTrips),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { stepSize: 1, color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
            
            // Chart 2: Time by day
            const ctx2 = document.getElementById('studentTimeChart');
            if (charts.studentTime) charts.studentTime.destroy();
            charts.studentTime = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayTime),
                    datasets: [{
                        label: 'Minutes',
                        data: Object.values(dayTime).map(ms => Math.round(ms / 60000)),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
            
            // Recent trips table (compact - just date and duration)
            const recent = filtered.slice().reverse().slice(0, 10);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(log => {
                const date = parseLocalDate(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const duration = log.duration || 0;
                const minutes = Math.floor(duration / 60000);
                
                let durationClass = 'duration-green';
                if (minutes >= 10) durationClass = 'duration-red';
                else if (minutes >= 5) durationClass = 'duration-yellow';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td class="${durationClass}">${formatDurationHours(duration)}</td>
                    </tr>
                `;
            });
            
            if (recent.length === 0) {
                html += '<tr><td colspan="2" class="no-data">No trips found</td></tr>';
            }
            
            html += '</tbody></table>';
            document.getElementById('studentTripsTable').innerHTML = html;
        }

        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
