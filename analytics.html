<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --color-ink: #0f172a;
            --color-slate: #475569;
            --color-cloud: #f1f5f9;
            --color-paper: #ffffff;
            --color-primary: #667eea;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-red: #dc2626;
            --color-black: #0f172a;
        }
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%);
            padding: 2rem;
            color: var(--color-ink);
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-content h1 { 
            font-family: 'Fraunces', serif; 
            font-size: 2rem; 
            margin-bottom: 0.5rem;
        }
        .header-content p {
            color: var(--color-slate);
            font-size: 0.9375rem;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .home-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--color-cloud);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }
        .home-icon:hover {
            background: var(--color-primary);
            color: white;
        }
        .home-icon svg {
            width: 20px;
            height: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-slate);
        }
        .tab:hover { background: var(--color-cloud); }
        .tab.active {
            background: var(--color-primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Slider Filters */
        .slider-filters {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .slider-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .slider-buttons {
            display: flex;
            gap: 0.5rem;
            background: var(--color-cloud);
            padding: 0.25rem;
            border-radius: 8px;
        }
        .slider-button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-slate);
            font-size: 0.875rem;
        }
        .slider-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .slider-button.active {
            background: white;
            color: var(--color-ink);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid var(--accent-color);
        }
        .stat-card[data-type="frequency"] { --accent-color: #667eea; }
        .stat-card[data-type="scans"] { --accent-color: #8b5cf6; }
        .stat-card[data-type="duration"] { --accent-color: #10b981; }
        .stat-card[data-type="over10"] { --accent-color: #f59e0b; }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--color-slate);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-ink);
        }
        .stat-subtitle {
            font-size: 0.875rem;
            color: var(--color-slate);
            margin-top: 0.25rem;
        }
        
        /* Two Column Layout for Charts */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-card h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-ink);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Top Students List */
        .top-students-list {
            list-style: none;
            padding: 0;
        }
        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--color-cloud);
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .student-item:hover {
            background: var(--color-cloud);
        }
        .student-item:last-child {
            border-bottom: none;
        }
        .student-rank {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            opacity: 0.3;
            min-width: 40px;
        }
        .student-info {
            flex: 1;
            margin-left: 1rem;
        }
        .student-name {
            font-weight: 600;
            color: var(--color-ink);
            margin-bottom: 0.25rem;
        }
        .student-trips {
            font-size: 0.875rem;
            color: var(--color-slate);
        }
        .student-duration {
            font-weight: 600;
            color: var(--color-primary);
        }
        
        /* Full Width Sections */
        .full-width-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .full-width-card h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--color-ink);
        }
        
        /* Student Report Tab */
        .student-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .student-selector h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 400px;
        }
        .select-wrapper select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-cloud);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-ink);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .select-wrapper select:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        
        .no-student-message {
            text-align: center;
            padding: 3rem;
            color: var(--color-slate);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 1rem;
            background: var(--color-cloud);
            font-weight: 600;
            color: var(--color-slate);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th:hover {
            background: #e2e8f0;
        }
        th.sortable::after {
            content: '⇅';
            margin-left: 0.5rem;
            opacity: 0.3;
        }
        th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }
        th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-cloud);
        }
        tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background: var(--color-cloud);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }
        .badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }
        .badge.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-danger);
        }
        
        .duration-green { color: var(--color-success); font-weight: 600; }
        .duration-yellow { color: var(--color-warning); font-weight: 600; }
        .duration-red { color: var(--color-danger); font-weight: 600; }
        
        /* Export Button */
        .export-btn {
            padding: 0.75rem 1.5rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        .export-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        @media (max-width: 968px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            #studentDetailsContainer > div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .slider-filters {
                flex-direction: column;
                gap: 1.5rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Analytics Dashboard</h1>
            <p>Track patterns, monitor trends, and export detailed reports</p>
        </div>
        <div class="header-actions">
            <a href="index.html" class="home-icon" title="Home">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
            </a>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Class Overview</button>
        <button class="tab" onclick="switchTab('student')">Student Report</button>
    </div>

    <!-- OVERVIEW TAB (Combined Overview + By Class) -->
    <div id="overviewTab" class="tab-content active">
        <!-- Filters -->
        <div class="slider-filters">
            <div class="slider-group">
                <div class="slider-label">Schedule</div>
                <div class="slider-buttons" id="overviewScheduleSlider">
                    <button class="slider-button active" data-value="Red">Red</button>
                    <button class="slider-button" data-value="Black">Black</button>
                </div>
            </div>
            
            <div class="slider-group">
                <div class="slider-label">Period</div>
                <div class="slider-buttons" id="overviewPeriodSlider">
                    <button class="slider-button active" data-value="1" data-name="Red1-Algebra">Red 1</button>
                    <button class="slider-button" data-value="2" data-name="Red2-Algebra">Red 2</button>
                    <button class="slider-button" data-value="3" data-name="Red3-PreAlgebra">Red 3</button>
                    <button class="slider-button" data-value="2" data-name="Black2-Geometry">Black 2</button>
                    <button class="slider-button" data-value="3" data-name="Black3-Geometry">Black 3</button>
                    <button class="slider-button" data-value="4" data-name="Black4-Algebra">Black 4</button>
                </div>
            </div>
            
            <div class="slider-group">
                <div class="slider-label">Time Range</div>
                <div class="slider-buttons" id="overviewTimeSlider">
                    <button class="slider-button" data-value="7days">Last 7 Days</button>
                    <button class="slider-button active" data-value="14days">Last 14 Days</button>
                    <button class="slider-button" data-value="30days">Last 30 Days</button>
                    <button class="slider-button" data-value="custom">Custom</button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" data-type="frequency">
                <div class="stat-label">Student Frequency</div>
                <div class="stat-value" id="overviewStudentFreq">0</div>
                <div class="stat-subtitle">unique students</div>
            </div>
            <div class="stat-card" data-type="scans">
                <div class="stat-label">Total Scans</div>
                <div class="stat-value" id="overviewTotalScans">0</div>
                <div class="stat-subtitle">in selected period</div>
            </div>
            <div class="stat-card" data-type="duration">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value" id="overviewAvgDuration">0m</div>
                <div class="stat-subtitle">per trip</div>
            </div>
            <div class="stat-card" data-type="over10">
                <div class="stat-label">Over 10 Min</div>
                <div class="stat-value" id="overviewOver10">0</div>
                <div class="stat-subtitle">trips exceeded</div>
            </div>
        </div>

        <!-- Charts Row: 14 Day Trend + Top 10 Students -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>14 Day Trend</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Top 10 Students</h3>
                <ul class="top-students-list" id="topStudentsList">
                    <li style="text-align: center; padding: 2rem; color: var(--color-slate);">Loading...</li>
                </ul>
            </div>
        </div>

        <!-- Full Width: All Students Table -->
        <div class="full-width-card">
            <h3>All Students</h3>
            <div id="allStudentsTable">
                <p style="text-align: center; padding: 2rem; color: var(--color-slate);">Loading...</p>
            </div>
        </div>
    </div>

    <!-- STUDENT REPORT TAB -->
    <div id="studentTab" class="tab-content">
        <div class="slider-filters">
            <div class="slider-group">
                <div class="slider-label">Schedule</div>
                <div class="slider-buttons" id="studentScheduleSlider">
                    <button class="slider-button active" data-value="Red">Red</button>
                    <button class="slider-button" data-value="Black">Black</button>
                </div>
            </div>
            
            <div class="slider-group">
                <div class="slider-label">Period</div>
                <div class="slider-buttons" id="studentPeriodSlider">
                    <button class="slider-button active" data-value="1" data-name="Red1-Algebra">Red 1</button>
                    <button class="slider-button" data-value="2" data-name="Red2-Algebra">Red 2</button>
                    <button class="slider-button" data-value="3" data-name="Red3-PreAlgebra">Red 3</button>
                    <button class="slider-button" data-value="2" data-name="Black2-Geometry">Black 2</button>
                    <button class="slider-button" data-value="3" data-name="Black3-Geometry">Black 3</button>
                    <button class="slider-button" data-value="4" data-name="Black4-Algebra">Black 4</button>
                </div>
            </div>
            
            <div class="slider-group">
                <div class="slider-label">Time Range</div>
                <div class="slider-buttons" id="studentTimeSlider">
                    <button class="slider-button" data-value="7days">Last 7 Days</button>
                    <button class="slider-button active" data-value="14days">Last 14 Days</button>
                    <button class="slider-button" data-value="30days">Last 30 Days</button>
                    <button class="slider-button" data-value="custom">Custom</button>
                </div>
            </div>
        </div>

        <div class="student-selector">
            <h3>Select Student</h3>
            <div class="select-wrapper">
                <select id="studentSelect" onchange="loadStudentData()">
                    <option value="">-- Select student --</option>
                </select>
            </div>
        </div>

        <div id="noStudentSelected" class="no-student-message">
            <p>Please select a student to view their detailed report</p>
        </div>

        <div id="studentDetailsContainer" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card" data-type="scans">
                    <div class="stat-label">Total Trips</div>
                    <div class="stat-value" id="studentTotalTrips">0</div>
                </div>
                <div class="stat-card" data-type="duration">
                    <div class="stat-label">Total Time Out</div>
                    <div class="stat-value" id="studentTotalTime">0h 0m</div>
                </div>
                <div class="stat-card" data-type="duration">
                    <div class="stat-label">Average Time</div>
                    <div class="stat-value" id="studentAvgTime">0m</div>
                </div>
                <div class="stat-card" data-type="over10">
                    <div class="stat-label">Longest Trip</div>
                    <div class="stat-value" id="studentLongestTrip">0m</div>
                </div>
                <div class="stat-card" data-type="over10">
                    <div class="stat-label">Trips Over 10 Min</div>
                    <div class="stat-value" id="studentTripsOver10">0</div>
                </div>
                <div class="stat-card" data-type="frequency">
                    <div class="stat-label">Forgot to Scan In</div>
                    <div class="stat-value" id="studentForgotRate">0%</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <div class="chart-card">
                    <h3>Trips by Day</h3>
                    <div class="chart-container">
                        <canvas id="studentTripsChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Time Out by Day</h3>
                    <div class="chart-container">
                        <canvas id="studentTimeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Recent Trips (Last 20)</h3>
                    <div id="studentTripsTable" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="full-width-card">
                <button class="export-btn" onclick="exportStudentReport()">Export Full Report (CSV)</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (REPLACE WITH YOUR CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allLogs = [];
        let charts = {
            trend: null,
            studentTrips: null,
            studentTime: null
        };

        const currentFilters = {
            overview: { schedule: 'Red', period: '1', timeRange: '14days', startDate: null, endDate: null },
            student: { schedule: 'Red', period: '1', timeRange: '14days', startDate: null, endDate: null }
        };

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'overview') {
                loadOverviewData();
            } else if (tabName === 'student') {
                populateStudentDropdown();
            }
        }

        // Slider Setup
        function setupSliders(prefix) {
            ['Schedule', 'Period', 'Time'].forEach(type => {
                const slider = document.getElementById(prefix + type + 'Slider');
                if (!slider) return;
                
                slider.querySelectorAll('.slider-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        slider.querySelectorAll('.slider-button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const key = type === 'Time' ? 'timeRange' : type.toLowerCase();
                        currentFilters[prefix === 'overview' ? 'overview' : 'student'][key] = btn.dataset.value;
                        
                        // When schedule changes, update period button visibility
                        if (type === 'Schedule') {
                            updatePeriodButtons(prefix, btn.dataset.value);
                        }
                        
                        if (prefix === 'overview') {
                            loadOverviewData();
                        } else if (prefix === 'student') {
                            const studentName = document.getElementById('studentSelect').value;
                            if (type === 'Schedule' || type === 'Period') {
                                populateStudentDropdown(); // Refresh student list when schedule/period changes
                            }
                            if (studentName) loadStudentData();
                        }
                    });
                });
            });
            
            // Initialize period button visibility
            const scheduleBtn = document.getElementById(prefix + 'ScheduleSlider').querySelector('.slider-button.active');
            if (scheduleBtn) {
                updatePeriodButtons(prefix, scheduleBtn.dataset.value);
            }
        }
        
        // Update period button visibility based on schedule
        function updatePeriodButtons(prefix, schedule) {
            const periodSlider = document.getElementById(prefix + 'PeriodSlider');
            if (!periodSlider) return;
            
            const scheduleDay = schedule.toLowerCase(); // "red" or "black"
            let firstVisibleBtn = null;
            
            periodSlider.querySelectorAll('.slider-button').forEach(btn => {
                const periodName = btn.dataset.name || '';
                const btnSchedule = periodName.toLowerCase().startsWith('red') ? 'red' : 'black';
                
                if (btnSchedule === scheduleDay) {
                    btn.style.display = '';
                    if (!firstVisibleBtn) firstVisibleBtn = btn;
                } else {
                    btn.style.display = 'none';
                    btn.classList.remove('active');
                }
            });
            
            // If no period is active, activate the first visible one
            const hasActive = Array.from(periodSlider.querySelectorAll('.slider-button.active'))
                .some(btn => btn.style.display !== 'none');
            
            if (!hasActive && firstVisibleBtn) {
                firstVisibleBtn.classList.add('active');
                const key = 'period';
                currentFilters[prefix === 'overview' ? 'overview' : 'student'][key] = firstVisibleBtn.dataset.value;
            }
        }

        // Utility Functions
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDurationHours(ms) {
            const totalMinutes = Math.floor(ms / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function getTimeRangeDates(rangeType, startId, endId) {
            const filter = rangeType === 'overviewTimeRange' ? currentFilters.overview : currentFilters.student;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let startDate, endDate;
            
            if (filter.timeRange === 'custom') {
                const startInput = document.getElementById(startId);
                const endInput = document.getElementById(endId);
                if (startInput && endInput && startInput.value && endInput.value) {
                    startDate = startInput.value;
                    endDate = endInput.value;
                } else {
                    const defaultStart = new Date(today);
                    defaultStart.setDate(today.getDate() - 14);
                    startDate = defaultStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                }
            } else {
                const days = parseInt(filter.timeRange.replace('days', ''));
                const start = new Date(today);
                start.setDate(today.getDate() - days);
                startDate = start.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            return { startDate, endDate };
        }

        // Load All Data
        async function loadAllData() {
            try {
                const snapshot = await db.ref('logs').once('value');
                const data = snapshot.val();
                
                allLogs = [];
                if (data) {
                    // New Firebase structure: logs is a flat list with push IDs
                    Object.entries(data).forEach(([logId, log]) => {
                        // Parse schedule string (e.g., "red_regular" -> scheduleDay: "red", startType: "regular")
                        let scheduleDay = 'red';
                        let startType = 'regular';
                        if (log.schedule) {
                            const parts = log.schedule.split('_');
                            scheduleDay = parts[0] || 'red'; // "red" or "black"
                            startType = parts[1] || 'regular'; // "regular" or "late"
                        }
                        
                        // Parse period name (e.g., "Red1-Algebra" -> period: "1", periodName: "Red1-Algebra")
                        let periodNumber = '1';
                        if (log.period) {
                            // Extract number from period name (Red1, Red2, Black2, etc.)
                            const match = log.period.match(/\d+/);
                            if (match) {
                                periodNumber = match[0];
                            }
                        }
                        
                        allLogs.push({
                            logId,
                            date: log.date,
                            period: periodNumber,
                            periodName: log.period, // Keep full name for reference
                            schedule: log.schedule, // Keep original schedule string
                            scheduleDay: scheduleDay, // Extracted: "red" or "black"
                            startType: startType, // Extracted: "regular" or "late"
                            studentName: log.studentName,
                            qrCode: log.qrCode,
                            action: log.action,
                            timestamp: log.timestamp,
                            duration: log.duration || 0,
                            outTime: log.outTime,
                            inTime: log.inTime
                        });
                    });
                }
                
                console.log('Loaded logs:', allLogs.length);
                console.log('Sample log:', allLogs[0]);
                setupSliders('overview');
                setupSliders('student');
                loadOverviewData();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load Overview Data
        function loadOverviewData() {
            const { schedule, period } = currentFilters.overview;
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            const range = getTimeRangeDates('overviewTimeRange', 'overviewStartDate', 'overviewEndDate');
            
            console.log('Loading overview:', { scheduleDay, period, range });
            
            // Filter logs: match scheduleDay AND period number
            // This combines data from both regular and late start for the same class
            const filtered = allLogs.filter(log =>
                log.scheduleDay === scheduleDay &&
                log.period === period &&
                log.date >= range.startDate &&
                log.date <= range.endDate &&
                (log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset' || log.action === 'manual-in')
            );
            
            console.log('Filtered logs:', filtered.length);
            console.log('Sample filtered:', filtered.slice(0, 3));
            
            // Calculate stats
            const uniqueStudents = new Set(filtered.map(log => log.studentName)).size;
            const totalScans = filtered.length;
            const totalDuration = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgDuration = totalScans > 0 ? totalDuration / totalScans : 0;
            const over10Min = filtered.filter(log => (log.duration || 0) > 600000).length;
            
            // Update stats
            document.getElementById('overviewStudentFreq').textContent = uniqueStudents;
            document.getElementById('overviewTotalScans').textContent = totalScans;
            document.getElementById('overviewAvgDuration').textContent = formatDurationHours(avgDuration);
            document.getElementById('overviewOver10').textContent = over10Min;
            
            // 14 Day Trend Chart
            const dayMap = {};
            const endDate = parseLocalDate(range.endDate);
            for (let i = 13; i >= 0; i--) {
                const d = new Date(endDate);
                d.setDate(endDate.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                dayMap[dateStr] = 0;
            }
            
            filtered.forEach(log => {
                if (dayMap.hasOwnProperty(log.date)) {
                    dayMap[log.date]++;
                }
            });
            
            const labels = Object.keys(dayMap).map(d => {
                const date = parseLocalDate(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const trendData = Object.values(dayMap);
            
            const ctx = document.getElementById('trendChart');
            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Trips',
                        data: trendData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
            
            // Top 10 Students
            const studentStats = {};
            filtered.forEach(log => {
                if (!log.studentName) return;
                if (!studentStats[log.studentName]) {
                    studentStats[log.studentName] = { trips: 0, duration: 0 };
                }
                studentStats[log.studentName].trips++;
                studentStats[log.studentName].duration += log.duration || 0;
            });
            
            const topStudents = Object.entries(studentStats)
                .sort((a, b) => b[1].trips - a[1].trips)
                .slice(0, 10);
            
            let html = '';
            if (topStudents.length === 0) {
                html = '<li style="text-align: center; padding: 2rem; color: var(--color-slate);">No data available</li>';
            } else {
                topStudents.forEach(([name, stats], index) => {
                    html += `
                        <li class="student-item" onclick="goToStudent('${name.replace(/'/g, "\\'")}')">
                            <div class="student-rank">${index + 1}</div>
                            <div class="student-info">
                                <div class="student-name">${name}</div>
                                <div class="student-trips">${stats.trips} trips</div>
                            </div>
                            <div class="student-duration">${formatDurationHours(stats.duration)}</div>
                        </li>
                    `;
                });
            }
            document.getElementById('topStudentsList').innerHTML = html;
            
            // All Students Table
            const allStudents = Object.entries(studentStats)
                .sort((a, b) => b[1].trips - a[1].trips);
            
            let tableHtml = `
                <table id="allStudentsTableEl">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortAllStudentsTable(0)">Rank</th>
                            <th class="sortable" onclick="sortAllStudentsTable(1)">Student Name</th>
                            <th class="sortable" onclick="sortAllStudentsTable(2)">Total Trips</th>
                            <th class="sortable" onclick="sortAllStudentsTable(3)">Total Time Out</th>
                            <th class="sortable" onclick="sortAllStudentsTable(4)">Avg Duration</th>
                            <th class="sortable" onclick="sortAllStudentsTable(5)">Over 10 Min</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (allStudents.length === 0) {
                tableHtml += '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--color-slate);">No data available</td></tr>';
            } else {
                allStudents.forEach(([name, stats], index) => {
                    const avgDur = stats.trips > 0 ? stats.duration / stats.trips : 0;
                    const over10 = filtered.filter(log => log.studentName === name && (log.duration || 0) > 600000).length;
                    
                    tableHtml += `
                        <tr style="cursor: pointer;" onclick="goToStudent('${name.replace(/'/g, "\\'")}')">
                            <td data-value="${index + 1}">${index + 1}</td>
                            <td data-value="${name}"><strong>${name}</strong></td>
                            <td data-value="${stats.trips}">${stats.trips}</td>
                            <td data-value="${stats.duration}">${formatDurationHours(stats.duration)}</td>
                            <td data-value="${avgDur}">${formatDurationHours(avgDur)}</td>
                            <td data-value="${over10}">${over10}</td>
                        </tr>
                    `;
                });
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('allStudentsTable').innerHTML = tableHtml;
        }

        // Sort all students table
        let allStudentsTableSortColumn = 2; // Default to trips
        let allStudentsTableSortAsc = false; // Descending by default

        function sortAllStudentsTable(columnIndex) {
            const table = document.getElementById('allStudentsTableEl');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length > 1);
            
            // Toggle sort direction if clicking same column
            if (allStudentsTableSortColumn === columnIndex) {
                allStudentsTableSortAsc = !allStudentsTableSortAsc;
            } else {
                allStudentsTableSortColumn = columnIndex;
                allStudentsTableSortAsc = true;
            }
            
            // Update header indicators
            table.querySelectorAll('th').forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (idx === columnIndex) {
                    th.classList.add(allStudentsTableSortAsc ? 'sort-asc' : 'sort-desc');
                }
            });
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].dataset.value;
                let bVal = b.cells[columnIndex].dataset.value;
                
                // Parse numeric values
                if (columnIndex !== 1) { // Not name column
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                if (aVal < bVal) return allStudentsTableSortAsc ? -1 : 1;
                if (aVal > bVal) return allStudentsTableSortAsc ? 1 : -1;
                return 0;
            });
            
            // Update rank column after sorting
            rows.forEach((row, index) => {
                tbody.appendChild(row);
                if (columnIndex !== 0) { // If not sorting by rank, update ranks
                    row.cells[0].textContent = index + 1;
                    row.cells[0].dataset.value = index + 1;
                }
            });
        }

        // Go to Student Report
        function goToStudent(studentName) {
            // Switch to student tab
            switchTab('student');
            
            // Set the same filters
            currentFilters.student = { ...currentFilters.overview };
            
            // Update UI sliders
            ['Schedule', 'Period', 'Time'].forEach(type => {
                const slider = document.getElementById('student' + type + 'Slider');
                if (!slider) return;
                
                slider.querySelectorAll('.slider-button').forEach(btn => {
                    const key = type === 'Time' ? 'timeRange' : type.toLowerCase();
                    if (btn.dataset.value === currentFilters.student[key]) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
            
            // Populate dropdown and select student
            populateStudentDropdown();
            setTimeout(() => {
                document.getElementById('studentSelect').value = studentName;
                loadStudentData();
            }, 100);
        }

        // Populate Student Dropdown
        function populateStudentDropdown() {
            const { schedule, period } = currentFilters.student;
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            
            const students = new Set();
            allLogs.forEach(log => {
                if (log.scheduleDay === scheduleDay && log.period === period && log.studentName) {
                    students.add(log.studentName);
                }
            });
            
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">-- Select student --</option>';
            Array.from(students).sort().forEach(name => {
                studentSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            document.getElementById('studentDetailsContainer').style.display = 'none';
            document.getElementById('noStudentSelected').style.display = 'block';
        }

        // Load Student Data
        function loadStudentData() {
            const studentName = document.getElementById('studentSelect').value;
            if (!studentName) {
                document.getElementById('studentDetailsContainer').style.display = 'none';
                document.getElementById('noStudentSelected').style.display = 'block';
                return;
            }
            
            document.getElementById('studentDetailsContainer').style.display = 'block';
            document.getElementById('noStudentSelected').style.display = 'none';
            
            const { schedule, period } = currentFilters.student;
            const scheduleDay = schedule === 'Red' ? 'red' : 'black';
            const range = getTimeRangeDates('studentTimeRange', 'studentStartDate', 'studentEndDate');
            
            const filtered = allLogs.filter(log =>
                log.studentName === studentName &&
                log.scheduleDay === scheduleDay &&
                log.period === period &&
                log.date >= range.startDate &&
                log.date <= range.endDate &&
                (log.action === 'in' || log.action === 'auto-reset' || log.action === 'manual-reset' || log.action === 'manual-in')
            );
            
            const totalTrips = filtered.length;
            const totalTime = filtered.reduce((sum, log) => sum + (log.duration || 0), 0);
            const avgTime = totalTrips > 0 ? totalTime / totalTrips : 0;
            const longestTrip = Math.max(...filtered.map(log => log.duration || 0), 0);
            const tripsOver10 = filtered.filter(log => (log.duration || 0) > 600000).length;
            const forgotCount = filtered.filter(log => 
                log.action === 'auto-reset' || log.action === 'manual-reset'
            ).length;
            const forgotRate = totalTrips > 0 ? (forgotCount / totalTrips * 100).toFixed(1) : 0;
            
            document.getElementById('studentTotalTrips').textContent = totalTrips;
            document.getElementById('studentTotalTime').textContent = formatDurationHours(totalTime);
            document.getElementById('studentAvgTime').textContent = formatDurationHours(avgTime);
            document.getElementById('studentLongestTrip').textContent = formatDurationHours(longestTrip);
            document.getElementById('studentTripsOver10').textContent = tripsOver10;
            document.getElementById('studentForgotRate').textContent = forgotRate + '%';
            
            // Trips by day
            const dayTrips = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
            const dayTime = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
            
            filtered.forEach(log => {
                const date = parseLocalDate(log.date);
                const day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                if (dayTrips[day] !== undefined) {
                    dayTrips[day]++;
                    dayTime[day] += log.duration || 0;
                }
            });
            
            const ctx1 = document.getElementById('studentTripsChart');
            if (charts.studentTrips) charts.studentTrips.destroy();
            charts.studentTrips = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayTrips),
                    datasets: [{
                        label: 'Trips',
                        data: Object.values(dayTrips),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
            
            const ctx2 = document.getElementById('studentTimeChart');
            if (charts.studentTime) charts.studentTime.destroy();
            charts.studentTime = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayTime),
                    datasets: [{
                        label: 'Time (minutes)',
                        data: Object.values(dayTime).map(ms => Math.round(ms / 60000)),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Recent trips table
            const recent = filtered.slice().reverse().slice(0, 20);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortStudentTable(0)">Date</th>
                            <th class="sortable" onclick="sortStudentTable(1)">Duration</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(log => {
                const date = parseLocalDate(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const duration = log.duration || 0;
                const minutes = Math.floor(duration / 60000);
                
                let durationClass = 'duration-green';
                if (minutes >= 10) durationClass = 'duration-red';
                else if (minutes >= 5) durationClass = 'duration-yellow';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td class="${durationClass}">${formatDurationHours(duration)}</td>
                    </tr>
                `;
            });
            
            if (recent.length === 0) {
                html += '<tr><td colspan="2" style="text-align: center; padding: 2rem; color: var(--color-slate);">No trips found</td></tr>';
            }
            
            html += '</tbody></table>';
            document.getElementById('studentTripsTable').innerHTML = html;
        }

        // Sort student table
        let studentTableSortColumn = -1;
        let studentTableSortAsc = true;

        function sortStudentTable(columnIndex) {
            const table = document.getElementById('studentTripsTable').querySelector('table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length > 1);
            
            // Toggle sort direction if clicking same column
            if (studentTableSortColumn === columnIndex) {
                studentTableSortAsc = !studentTableSortAsc;
            } else {
                studentTableSortColumn = columnIndex;
                studentTableSortAsc = true;
            }
            
            // Update header indicators
            table.querySelectorAll('th').forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (idx === columnIndex) {
                    th.classList.add(studentTableSortAsc ? 'sort-asc' : 'sort-desc');
                }
            });
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                
                // Parse duration for proper sorting
                if (columnIndex === 1) {
                    aVal = parseDuration(aVal);
                    bVal = parseDuration(bVal);
                } else if (columnIndex === 0) {
                    // Parse date
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }
                
                if (aVal < bVal) return studentTableSortAsc ? -1 : 1;
                if (aVal > bVal) return studentTableSortAsc ? 1 : -1;
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function parseDuration(str) {
            // Parse "5h 23m" or "15m" into minutes
            let total = 0;
            const hours = str.match(/(\d+)h/);
            const minutes = str.match(/(\d+)m/);
            if (hours) total += parseInt(hours[1]) * 60;
            if (minutes) total += parseInt(minutes[1]);
            return total;
        }

        // Export Student Report
        function exportStudentReport() {
            const studentName = document.getElementById('studentSelect').value;
            if (!studentName) {
                alert('Please select a student first');
                return;
            }
            
            const filtered = allLogs.filter(log => log.studentName === studentName);
            let csv = 'Date,Period,Schedule,Action,Duration (minutes)\n';
            filtered.forEach(log => {
                const duration = log.duration ? (log.duration / 60000).toFixed(2) : '0';
                csv += `${log.date},${log.period},${log.schedule},${log.action},${duration}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${studentName.replace(/\s+/g, '-')}-report-${Date.now()}.csv`;
            a.click();
        }

        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
